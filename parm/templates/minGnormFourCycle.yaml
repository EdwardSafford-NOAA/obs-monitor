#
# Gnorm 4 cycle plots for MinMon gfs
#
# Generate one plot:
#   - gnorm values (all iterations) for last 4 cycles & 7 day avg


# Data read
# ---------
datasets:
  - name: gnorm
    type: MonDataSpace
    control_file:
      - {{CONTROL}}/minAllGnorm.ctl
    filenames:
      {% for i in range(0, 168, 6) %}
      {% set offset_hr = i | string %}
      {% set offset_str = "-" + offset_hr + "H" %}
      {% set offset_td = offset_str | to_timedelta %}
      {% set PDATEnew = PDATE | add_to_datetime(offset_td) %}
      - {{ DATA }}/{{ PDATEnew | to_YMDH }}.gnorms.ieee_d
      {% endfor %}

    groups:
      - name: GsiIeee
        variables: &variables ['gnorm']

transforms:
  - transform: select time
    new name: gnorm::GsiIeee::log_gnorm_cyc1
    starting field: gnorm::GsiIeee::log_gnorm
    cycle: {{ PDATE | to_YMDH }}
    for:
      variable: [none]

  - transform: select time
    new name: gnorm::GsiIeee::log_gnorm_cyc2
    starting field: gnorm::GsiIeee::log_gnorm
    cycle: {{ PDATEm6 | to_YMDH }}
    for:
      variable: [none]

  - transform: select time
    new name: gnorm::GsiIeee::log_gnorm_cyc3
    starting field: gnorm::GsiIeee::log_gnorm
    cycle: {{ PDATEm12 | to_YMDH }}
    for:
      variable: [none]

  - transform: select time
    new name: gnorm::GsiIeee::log_gnorm_cyc4
    starting field: gnorm::GsiIeee::log_gnorm
    cycle: {{ PDATEm18 | to_YMDH }}
    for:
      variable: [none]

  - transform: select time
    new name: gnorm::GsiIeee::log_gnorm_7d
    starting field: gnorm::GsiIeee::log_gnorm
    start cycle: {{ PDATE | to_YMDH }}
    end cycle: {{ PDATEm162 | to_YMDH }}
    for:
      variable: [none]

graphics:

  plotting_backend: Emcpy
  figure_list:

    # Gnorm single cycle & 7 day hourly mean
    # --------------------------------------
    - figure:
        layout: [1,1]
        figure size: [20,18]
#        tight layout:
        title: "Valid: {{ PDATE | to_YMDH }}"
        output name: line_plots/min/{{MODEL}}_{{RUN}}.4cycle.gnorms.png
          #        plot logo:
          #          which: 'noaa/nws'
          #          loc: 'upper center'

      plots:
        - add_xlabel: 'Iteration Number'
          add_ylabel: 'log( gnorm )'
          add_grid:
            axis: 'both'
            linestyle: 'dotted'
            linewidth: 0.5
            color: 'black'
          add_legend:
            loc: 'upper right'
          layers:
          - type: LinePlot
            x:
              variable: gnorm::GsiIeee::iteration
            y:
              variable: gnorm::GsiIeee::log_gnorm_cyc1
            color: 'blue'
            label: '{{ PDATE | to_YMDH }}'
          - type: LinePlot
            x:
              variable: gnorm::GsiIeee::iteration
            y:
              variable: gnorm::GsiIeee::log_gnorm_cyc2
            color: 'red'
            label: '{{ PDATEm6 | to_YMDH }}'
          - type: LinePlot
            x:
              variable: gnorm::GsiIeee::iteration
            y:
              variable: gnorm::GsiIeee::log_gnorm_cyc3
            color: 'green'
            label: '{{ PDATEm12 | to_YMDH }}'
          - type: LinePlot
            x:
              variable: gnorm::GsiIeee::iteration
            y:
              variable: gnorm::GsiIeee::log_gnorm_cyc4
            color: 'orange'
            label: '{{ PDATEm18 | to_YMDH }}'
          - type: LinePlot
            x:
              variable: gnorm::GsiIeee::iteration
            y:
              variable: gnorm::GsiIeee::log_gnorm_7d
            color: 'black'
            label: '7 day mean'
